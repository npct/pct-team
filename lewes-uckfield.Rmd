---
title: 'Cycling potential around a proposed railway line in Sussex: deliverable 5.3'
author: "Robin Lovelace"
date: "`r Sys.Date()`"
output: bookdown::html_document2
bibliography: documents/references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = F)
pkgs = c("sp", "tmap", "rgeos", "stplanr")
lapply(pkgs, library, character.only = T)
```

# Introduction

## Rail-related deliverables in the PCT project

Deliverables 5.1, 5.2 and 5.3 in Phase II of the Propensity to Cycle Tool (PCT) project are related to the interaction between cycling and rail.
They are as follows:

- Task 5.1 Modify the PCT methodology to identify ‘parallels’ and ‘severance points’.  Deliverable is a short report, by 30 September 2016.
- Task 5.2 Roll-out of a version of the PCT to highlight cycling opportunities raised by HS2.  Deliverable is a short report, by 30 November 2016.
- Task 5.3 Case study of new railway line in Sussex: 30 September 2016.  Deliverable is a short report, by 30 September 2016.

This document represents the delivery of Tasks 5.1 and 5.3 from the above list and will be used as a foundation to deliver Task 5.2.

In the contract deliverable 5.2 is described as looking at cycling opportunities along the *route* of the HS2 train line. However subsequent discussions with DfT staff (Shane Snow) have indicated that the cycling potential around the *proposed cycle path* surrounding HS2 that is of most interest. It has therefore been agreed that 5.3 will analyse the cycling potential in the wider area covered by the proposed path, rather than just the route of HS2. Because this new piece of work is more challenging, it has further been agreed that, rather than a full quantitative analysis of the cycling potential along every segment of the entire cycle path, the analysis associated with 5.2 will focus on overlaying the proposed route with estimates of cycling potential from the PCT, with the aim of providing an evidence base for investing in and potentially modifying the proposed cycle path surrounding the HS2.

This report, however, focusses exclusively on the much smaller area surrounded by the proposed Lewes-Uckfield rail route.

# Methodology

## Identifying 'parallels' to linear features

To identify parallels to linear features, a 4 stage methodology was developed. Although this is described below in relation to the Lewes-Uckfield train line, it could be applied to any linear feature of interest:

- Subset cycling desire lines to include only those which pass in close proximity to the train line. For thise analysis, this was defined as 10 km.
- Break the train line of interest into segments of even distance
- Calculate the angle of the segments of the train line and desire lines
- Subset the desire lines again, to include only those that are 'parallel' or within a threshold angle of their closest segment
- Aggregate the cycling potential of all parallel lines per segment. The minimum threshold angle using this project was X degrees.

## Identifying potential 'severance points'

Severance occurs when active travel along cyclable desire lines with high cycling potential is prevented or made more difficult by obstacles such as rivers, fast roads or railway tracks. A degree of severance can be expected along the full length of linear features, as most desire lines have at least some cycling potential. However, the degree of severance will be greatest in certain *severance pinch points* (henceforth referred to as severance points), for example points along a rail track which intersect desire lines connecting residential areas with employment zones on the other side.

The methodology used to identify these severance points consists of 3 stages:

- Identify the desire lines which intersect with the train line..
- Quantify the number of potential cyclists blocked along segments of the train line of even length.
- Subset the segments which block the highest number of potential cyclists and identify potential crossing points

Note that based on the three-stage methodology outlined above severance points are in fact more precisely described as 'severance segments', along which a range of points could be chosen for crossing points. However, the term 'severance point' is more intuitive so we use this term throughout.

# A case study of Lewes-Uckfield

The Lewes-Uckfield train line is a proposed project to restore a rail link between Uckfield and Lewes. This is part of wider plans to increase rail capacity in the area. As stated in the project brief, "Such infrastructure has the potential to support cycling if high quality infrastructure is built alongside." This appendix analyses cycling potential along the proposed route, which is 16 km in length (see Figure \@ref(fig:lc)).

<!-- # Cycling potential surrounding the Lewes-Uckfield trainline -->

```{r, echo=FALSE, warning=FALSE}
# # Basic stats on Lewes-Uckfield route
lewes_uckfield = readRDS("input-data/lewes_uckfield.Rds")
lewes_uckfield_osgb = spTransform(lewes_uckfield, CRS("+init=epsg:27700"))
# gLength(lewes_uckfield_osgb) / 1000
# z = readRDS("../pct-bigdata/ukmsoas-scenarios.Rds")
# l = readRDS("../pct-bigdata/pct_lines_oneway_shapes.Rds")
# l$`Percent cycling` = l$bicycle / l$all * 100
# cents = geojsonio::geojson_read("../pct-bigdata/cents-scenarios.geojson", what = "sp")
# 
# # names(cents)
# # Generate and save objects specific to the project (to save loading large datasets)
# buff = buff_geo(lewes_uckfield, width = 10000)
# proj4string(cents) = proj4string(lewes_uckfield)
# cents_lc = cents[buff,]
# z_lc = z[cents_lc,]
# l_lc = l[buff,]
# save(buff, cents_lc, z_lc, l_lc, file = "input-data/lewes_uckfield_objects.Rdata")
load("input-data/lewes_uckfield_objects.Rdata")
# plot(cents_lc)
# sum(cents_lc$all)
```

## Current travel patterns

There are `r nrow(cents_lc)` MSOAs whose population weighted centroids lie within a 10 km buffer of the train line, representing `r sum(cents_lc$all)` commuters. This area is illustrated in Figure \@ref(fig:lc).

```{r lc, fig.cap="Overview of the Lewes-Uckfiled line with a 10 km buffer (blue). Width is proportional to the number of commutes, colour represents the proportion of people who cycle. Thanks to Matthew Whittle who digitised a scanned image of the proposed route."}
# osm_tiles = read_osm(bb(z_lc, 1.05), type = "stamen-toner")
# saveRDS(osm_tiles, "data-sources/osm_tiles_ukfield.Rds")
osm_tiles = readRDS("data-sources/osm_tiles_ukfield.Rds")
qtm(osm_tiles) +
  tm_shape(buff) + tm_borders(col = "blue", lwd = 3) +
  tm_shape(l_lc) + tm_lines(lwd = "all", scale = 20, col = "Percent cycling", alpha = 0.5, n = 5, breaks = 2^(-1:4),
                              palette = "Spectral", auto.palette.mapping = F, ) +
  tm_shape(lewes_uckfield) + tm_lines(lwd = 5, col = "black") 
# knitr::include_graphics("figures/lewes-uckfield-overview.png")
```

The total number of single-stage commutes that pass through the buffer is higher: `r sum(l_lc$all)` commuters. As Figure \@ref(fig:lc) illustrates, many of these commuters would not interact with the train line, as they are focused on commutes between Brighton and surrounding settlements in the far southeast of the 20 km buffer. Only a few hundred commutes pass directly parallel to the route, mostly due to 10 to 20 km (route distance) commutes between MSOAs in Lewes, Ringmer and Uckfield. This implies that cycle paths running parallel to the train line itself have quite low commuter cycling potential. The next section analyses this potential in more detail.

## Cycling potential parallel to the route

```{r}
# get angle of desire lines
l_lc$angle = line_bearing(l_lc, bidirectional = T)

# split rail route into segments
source("R/points_to_line.R")
pseg = spsample(lewes_uckfield_osgb, n = 5, type = "regular")
plot(pseg)
# try to create 1st line segment
ldf = ggplot2::fortify(lewes_uckfield_osgb)
ldfp = SpatialPointsDataFrame(coords = cbind(ldf$long, ldf$lat), data = ldf)
# find closest point
# install.packages("nabor")
library(nabor)
knn_res = knn(data = coordinates(ldfp), query = coordinates(pseg), k = 1)
sel_nearest = c(knn_res$nn.idx)
points(ldfp[sel_nearest,]) # check they are close by
for(i in 1:(length(sel_nearest) + 1)){
  ids = c(1, sel_nearest, nrow(ldfp))
  if(i == 1){
    l = points_to_line(ldf[ids[i]:ids[(i + 1)],], "long", "lat")
    spChFIDs(l) = i
  } else {
    l_temp = points_to_line(ldf[ids[i]:ids[(i + 1)],], "long", "lat")
    spChFIDs(l_temp) = i
    l = maptools::spRbind(l, l_temp)
  }
}




ldfl = points_to_line(ldfp, "long", "lat")


```


## The potential for severance along the proposed route

## Cycling potential around the proposed route

Under the ambitious Ebike scenario, the PCT shows that cycling potential along routes running parallel to the line is uneven geographically. Unsurprisingly, cycling potential is clustered at either end of the proposed route, with relatively high increases modelled along segments of the network between Lewes and Ringmer (an increase from 35 to 336 commuters is modelled along a section of the B2192 running west from Lewes) and routes running north-south through Uckfield. This is shown in Figure \@ref(fig:pct-uck).

```{r pct-uck, fig.cap="Cycling potential along the transport network between Lewes and Uckfield, under the Ebike scenario of the Propensity to Cycle Tool (see [pct.bike/east-sussex/](http://pct.bike/east-sussex/))."}
knitr::include_graphics("figures/lewes-uckfield-pct-ebike.png")
```